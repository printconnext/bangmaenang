<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข่าวสาร - เทศบาลเมืองบางแม่นาง</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #f8fafc;
            padding-bottom: 50px;
        }

        .admin-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1e293b;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            font-size: 16px;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            transition: opacity 0.3s;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .alert-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .media-preview-container {
            position: relative;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .delete-media-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0;
            z-index: 10;
        }

        .delete-media-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Login Overlay Styles */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2>เว็บไซต์บางแม่นาง หมู่ 5</h2>
            <p style="margin-bottom: 20px; color: #64748b;">กรุณาเข้าสู่ระบบเพื่อจัดการข่าวสาร</p>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label for="username">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="password">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" required
                        style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Kanit'; font-size: 16px;">
                </div>
                <div id="loginError" class="alert alert-error"
                    style="display:none; padding:10px; margin-bottom:15px; margin-top:0;">
                    ชื่อผู้ใช้ หรือ รหัสผ่านไม่ถูกต้อง
                </div>
                <button type="submit" class="submit-btn">เข้าสู่ระบบ (Login)</button>
                <a href="index.html" class="back-link" style="margin-top: 15px; margin-bottom: 0;">← กลับไปหน้าแรก</a>
            </form>
        </div>
    </div>

    <div class="admin-container" id="adminPanel" style="display: none;">
        <a href="index.html" class="back-link">← กลับไปหน้าแรก</a>

        <div class="admin-header">
            <h2>ระบบเพิ่มข่าวสาร (Admin)</h2>
            <p>กรอกข้อมูลด้านล่างเพื่อเพิ่มข่าวใหม่ขึ้นสู่หน้าเว็บไซต์ทันที</p>
        </div>

        <form id="addNewsForm">
            <!-- Hidden field for keeping track of the article being edited -->
            <input type="hidden" id="editArticleId" value="">

            <div class="form-group">
                <label for="title">หัวข้อข่าว *</label>
                <input type="text" id="title" required placeholder="เช่น โครงการปรับปรุงภูมิทัศน์ชุมชนหมู่ 5">
            </div>

            <div class="form-group">
                <label for="content">รายละเอียดข่าว *</label>
                <textarea id="content" required placeholder="เนื้อหาประกาศ..."></textarea>
            </div>

            <div class="form-group">
                <label for="date_str">วันที่แสดงผล (ไม่บังคับ)</label>
                <input type="text" id="date_str" placeholder="เช่น 25 มีนาคม 2567 (ถ้าเว้นว่างจะใช้วันที่ปัจจุบัน)">
            </div>

            <div class="form-group">
                <label for="image_upload">อัปโหลดรูปภาพหน้าปก (ไม่บังคับ - 1 รูป)</label>
                <div id="currentCoverPreview" style="margin-bottom: 10px; display: none;">
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 5px;">รูปหน้าปกปัจจุบัน:</p>
                    <div class="media-preview-container">
                        <img id="currentCoverImg" src="" alt="Cover Preview"
                            style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e2e8f0; object-fit: cover;">
                        <button type="button" class="delete-media-btn" onclick="markCoverForDeletion()"
                            title="ลบรูปหน้าปกเดิม">X</button>
                    </div>
                </div>
                <input type="file" id="image_upload" accept="image/*">
                <small style="color: #64748b; margin-top: 5px; display: block;">อัปโหลดไฟล์ใหม่เพื่อแทนที่รูปเดิม
                    หรือปล่อยว่างไว้เพื่อใช้รูปเดิม (รองรับ .jpg, .png)</small>
            </div>

            <div class="form-group">
                <label for="gallery_upload">อัปโหลดรูปประกอบเนื้อหาข่าว (Gallery) (ไม่บังคับ - หลายรูป)</label>
                <div id="currentGalleryPreview" style="margin-bottom: 10px; display: none;">
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 5px;">รูปประกอบปัจจุบัน:</p>
                    <div id="currentGalleryContainer" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <!-- Gallery images injected here -->
                    </div>
                </div>
                <input type="file" id="gallery_upload" accept="image/*" multiple>
                <small style="color: #64748b; margin-top: 5px; display: block;">ถ้าเลือกไฟล์ใหม่
                    ระบบจะนำไปบวกเพิ่มหรือแทนที่ ขึ้นอยู่กับการจัดการ (ตอนนี้จะทำงานแบบเพิ่ม/แทนที่ทับของเดิม)</small>
            </div>

            <div class="form-group">
                <label for="video_upload">อัปโหลดวิดีโอ (ไม่บังคับ - 1 คลิป)</label>
                <div id="currentVideoPreview" style="margin-bottom: 10px; display: none;">
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 5px;">วิดีโอปัจจุบัน:</p>
                    <div class="media-preview-container" style="display: block;">
                        <video id="currentVideoPlayer" controls
                            style="max-width: 100%; max-height: 250px; border-radius: 8px; border: 1px solid #e2e8f0;"></video>
                        <button type="button" class="delete-media-btn" onclick="markVideoForDeletion()"
                            title="ลบวิดีโอเดิม">X</button>
                    </div>
                </div>
                <!-- Accept mp4, webm, and ogg, or general video -->
                <input type="file" id="video_upload" accept="video/mp4,video/webm,video/ogg,video/*">
                <small style="color: #64748b; margin-top: 5px; display: block;">อัปโหลดไฟล์วิดีโอใหม่เพื่อแทนที่ของเดิม
                    (ขนาดไฟล์ไม่ควรใหญ่เกินไป)</small>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">บันทึกและเผยแพร่ข่าว</button>
        </form>

        <div id="alertBox" class="alert"></div>

        <div style="margin-top: 50px; border-top: 1px solid #e2e8f0; padding-top: 30px;">
            <h3>รายการข่าวสารทั้งหมด</h3>
            <div style="overflow-x: auto; margin-top: 15px;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="background-color: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                            <th style="padding: 12px; border: 1px solid #e2e8f0; width: 80px; text-align: center;">
                                รูปภาพ</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">หัวข้อข่าว</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0; width: 150px;">วันที่ลง</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0; width: 120px;">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="adminNewsTableBody">
                        <!-- News rows will be injected here -->
                        <tr>
                            <td colspan="4" style="text-align:center; padding: 20px;">กำลังโหลด...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js?v=2"></script>
    <script>
        // --- Login Logic ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('loginError');

            if (user === 'admin' && pass === 'admin123') {
                // Success
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminNews();
                // Optional: Save to sessionStorage briefly so they don't have to log in on every refresh
                sessionStorage.setItem('isAdminLoggedIn', 'true');
            } else {
                // Error
                errorMsg.style.display = 'block';
            }
        });

        // Check if already logged in this session
        if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminNews(); // Load news when panel is shown
        }

        // State variables for tracking media deletion in edit mode
        let removeCover = false;
        let removeVideo = false;
        let removedGalleryUrls = [];

        // Helper to reset form fully
        function resetAdminForm() {
            document.getElementById('addNewsForm').reset();
            document.getElementById('editArticleId').value = '';

            const btn = document.getElementById('submitBtn');
            btn.textContent = 'บันทึกและเผยแพร่ข่าว';
            btn.style.backgroundColor = 'var(--primary-color)';

            // Reset delete state
            removeCover = false;
            removeVideo = false;
            removedGalleryUrls = [];

            // Hide image previews
            document.getElementById('currentCoverPreview').style.display = 'none';
            document.getElementById('currentCoverImg').src = '';
            document.getElementById('currentGalleryPreview').style.display = 'none';
            document.getElementById('currentGalleryContainer').innerHTML = '';
            document.getElementById('currentVideoPreview').style.display = 'none';
            document.getElementById('currentVideoPlayer').src = '';
        }

        // --- Media Deletion Handlers ---
        window.markCoverForDeletion = function () {
            removeCover = true;
            document.getElementById('currentCoverPreview').style.display = 'none';
        }

        window.markVideoForDeletion = function () {
            removeVideo = true;
            document.getElementById('currentVideoPreview').style.display = 'none';
            document.getElementById('currentVideoPlayer').src = '';
        }

        window.markGalleryItemForDeletion = function (url, index) {
            removedGalleryUrls.push(url);
            document.getElementById('gallery-item-' + index).style.display = 'none';
        }

        // --- Load News into Admin Table ---
        async function loadAdminNews() {
            const tbody = document.getElementById('adminNewsTableBody');

            try {
                const { data: newsItems, error } = await supabaseClient
                    .from('news')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!newsItems || newsItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #64748b;">ยังไม่มีข้อมูลข่าวสาร</td></tr>';
                    return;
                }

                let html = '';
                newsItems.forEach(item => {
                    const dateDisplay = item.date_str || new Date(item.created_at).toLocaleDateString('th-TH');

                    let thumbHtml = '';
                    if (item.image_url) {
                        thumbHtml = `<img src="${item.image_url}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #e2e8f0;">`;
                    } else if (item.video_url) {
                        thumbHtml = `<div style="width: 60px; height: 40px; background: #e2e8f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #64748b;" title="มีวิดีโอ"><i class="fa-solid fa-play"></i></div>`;
                    } else {
                        thumbHtml = `<div style="width: 60px; height: 40px; background: #f1f5f9; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #cbd5e1;" title="ไม่มีรูปภาพ"><i class="fa-regular fa-image"></i></div>`;
                    }

                    html += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${thumbHtml}</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0;">${item.title || 'ไม่มีหัวข้อ'}</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0;">${dateDisplay}</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">
                                <button onclick="editArticle('${item.id}')" style="background:#f59e0b; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; margin-right:5px; font-family:'Kanit';">แก้ไข</button>
                                <button onclick="deleteArticle('${item.id}')" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-family:'Kanit';">ลบ</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;

            } catch (err) {
                console.error('Error loading news:', err);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #ef4444;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
            }
        }

        // --- Edit Article ---
        window.editArticle = async function (id) {
            try {
                const { data, error } = await supabaseClient
                    .from('news')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Populate form
                document.getElementById('editArticleId').value = data.id;
                document.getElementById('title').value = data.title;
                document.getElementById('content').value = data.content;
                document.getElementById('date_str').value = data.date_str || '';

                // Reset delete state for new edit session
                removeCover = false;
                removeVideo = false;
                removedGalleryUrls = [];

                // Show cover preview if exists
                if (data.image_url) {
                    document.getElementById('currentCoverPreview').style.display = 'block';
                    document.getElementById('currentCoverImg').src = data.image_url;
                } else {
                    document.getElementById('currentCoverPreview').style.display = 'none';
                }

                // Show gallery preview if exists
                const galleryContainer = document.getElementById('currentGalleryContainer');
                galleryContainer.innerHTML = '';
                if (data.gallery_urls) {
                    let urls = [];
                    if (typeof data.gallery_urls === 'string') {
                        try { urls = JSON.parse(data.gallery_urls); } catch (e) { }
                    } else if (Array.isArray(data.gallery_urls)) {
                        urls = data.gallery_urls;
                    }

                    if (urls.length > 0) {
                        document.getElementById('currentGalleryPreview').style.display = 'block';
                        urls.forEach((url, i) => {
                            galleryContainer.innerHTML += `
                                <div class="media-preview-container" id="gallery-item-${i}">
                                    <img src="${url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #cbd5e1;">
                                    <button type="button" class="delete-media-btn" onclick="markGalleryItemForDeletion('${url}', ${i})" title="ลบรูปนี้">X</button>
                                </div>
                            `;
                        });
                    } else {
                        document.getElementById('currentGalleryPreview').style.display = 'none';
                    }
                } else {
                    document.getElementById('currentGalleryPreview').style.display = 'none';
                }

                // Show video preview if exists
                if (data.video_url) {
                    document.getElementById('currentVideoPreview').style.display = 'block';
                    document.getElementById('currentVideoPlayer').src = data.video_url;
                } else {
                    document.getElementById('currentVideoPreview').style.display = 'none';
                }

                // Change UI
                document.getElementById('submitBtn').textContent = 'อัปเดตข้อมูลข่าวสาร';
                document.getElementById('submitBtn').style.backgroundColor = '#f59e0b';

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                console.error("Error fetching article for edit:", err);
                alert("เกิดข้อผิดพลาดในการดึงข้อมูลข่าวสาร");
            }
        };

        // --- Delete Article ---
        window.deleteArticle = async function (id) {
            if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข่าวสารนี้? (การลบจะไม่สามารถกู้คืนได้)')) {
                return;
            }

            try {
                // Note: We are deleting the row. Ideally, we should also delete associated images from storage.
                // For simplicity now, we just delete the database row.
                const { error } = await supabaseClient
                    .from('news')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert("ลบข่าวสารเรียบร้อยแล้ว");
                loadAdminNews(); // Refresh table

            } catch (err) {
                console.error("Error deleting article:", err);
                alert("เกิดข้อผิดพลาดในการลบข่าวสาร: " + err.message);
            }
        };

        // --- Add/Update News Logic ---
        document.getElementById('addNewsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const alertBox = document.getElementById('alertBox');
            const editId = document.getElementById('editArticleId').value;

            btn.textContent = 'กำลังบันทึก...';
            btn.disabled = true;

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            let date_str = document.getElementById('date_str').value;

            const imageFile = document.getElementById('image_upload').files[0];
            const galleryFiles = document.getElementById('gallery_upload').files;
            const videoFile = document.getElementById('video_upload').files[0];

            let image_url = null;
            let gallery_urls = [];
            let video_url = null;

            if (!date_str) date_str = null;

            try {
                // 1. Upload Cover Image (If selected)
                if (imageFile) {
                    btn.textContent = 'กำลังอัปโหลดรูปหน้าปก...';
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${Date.now()}_cover_${Math.random().toString(36).substring(2, 9)}.${fileExt}`;

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('news-images')
                        .upload(fileName, imageFile);

                    if (uploadError) {
                        throw new Error('อัปโหลดรูปหน้าปกไม่สำเร็จ: ' + uploadError.message);
                    }

                    const { data: publicUrlData } = supabaseClient.storage
                        .from('news-images')
                        .getPublicUrl(fileName);

                    image_url = publicUrlData.publicUrl;
                }

                // 2. Upload Gallery Images (If selected)
                if (galleryFiles && galleryFiles.length > 0) {
                    for (let i = 0; i < galleryFiles.length; i++) {
                        const gFile = galleryFiles[i];
                        btn.textContent = `กำลังอัปโหลดรูปประกอบ (${i + 1}/${galleryFiles.length})...`;

                        const fileExt = gFile.name.split('.').pop();
                        const fileName = `${Date.now()}_gallery_${i}_${Math.random().toString(36).substring(2, 9)}.${fileExt}`;

                        const { error: uploadError } = await supabaseClient.storage
                            .from('news-images')
                            .upload(fileName, gFile);

                        if (uploadError) {
                            throw new Error(`อัปโหลดรูปประกอบที่ ${i + 1} ไม่สำเร็จ: ` + uploadError.message);
                        }

                        const { data: publicUrlData } = supabaseClient.storage
                            .from('news-images')
                            .getPublicUrl(fileName);

                        gallery_urls.push(publicUrlData.publicUrl);
                    }
                }

                // 2.5 Upload Video (If selected)
                if (videoFile) {
                    btn.textContent = 'กำลังอัปโหลดวิดีโอ...';
                    const fileExt = videoFile.name.split('.').pop();
                    const fileName = `${Date.now()}_video_${Math.random().toString(36).substring(2, 9)}.${fileExt}`;

                    const { error: uploadError } = await supabaseClient.storage
                        .from('news-images') // Reusing the same public bucket for simplicity
                        .upload(fileName, videoFile);

                    if (uploadError) {
                        throw new Error('อัปโหลดวิดีโอไม่สำเร็จ: ' + uploadError.message);
                    }

                    const { data: publicUrlData } = supabaseClient.storage
                        .from('news-images')
                        .getPublicUrl(fileName);

                    video_url = publicUrlData.publicUrl;
                }

                // 3. Prepare payload for Insertion
                const insertPayload = {
                    title: title,
                    content: content,
                    date_str: date_str,
                    image_url: image_url,
                    video_url: video_url
                };

                if (gallery_urls.length > 0) {
                    // Supabase JS allows inserting objects/arrays directly into JSONB columns natively.
                    insertPayload.gallery_urls = gallery_urls;
                }

                // 4. Insert or Update Database
                if (editId) {
                    btn.textContent = 'กำลังอัปเดตข้อมูล...';

                    // Fetch existing data to preserve old URLs if no new ones are uploaded (and not marked for deletion)
                    const { data: existingData } = await supabaseClient.from('news').select('*').eq('id', editId).single();

                    if (existingData) {
                        if (!imageFile) {
                            insertPayload.image_url = removeCover ? null : existingData.image_url;
                        }

                        if (!videoFile) {
                            insertPayload.video_url = removeVideo ? null : existingData.video_url;
                        }

                        if (galleryFiles.length === 0) {
                            // If no new files uploaded, preserve old ones minus explicitly deleted ones
                            if (existingData.gallery_urls) {
                                let oldUrls = [];
                                if (typeof existingData.gallery_urls === 'string') {
                                    try { oldUrls = JSON.parse(existingData.gallery_urls); } catch (e) { }
                                } else if (Array.isArray(existingData.gallery_urls)) {
                                    oldUrls = existingData.gallery_urls;
                                }

                                const remainingUrls = oldUrls.filter(url => !removedGalleryUrls.includes(url));
                                insertPayload.gallery_urls = remainingUrls.length > 0 ? remainingUrls : null;
                            } else {
                                insertPayload.gallery_urls = null;
                            }
                        } else {
                            // If new files ARE uploaded, we APPEND them to the remaining old ones
                            let remainingUrls = [];
                            if (existingData.gallery_urls) {
                                let oldUrls = [];
                                if (typeof existingData.gallery_urls === 'string') {
                                    try { oldUrls = JSON.parse(existingData.gallery_urls); } catch (e) { }
                                } else if (Array.isArray(existingData.gallery_urls)) {
                                    oldUrls = existingData.gallery_urls;
                                }
                                remainingUrls = oldUrls.filter(url => !removedGalleryUrls.includes(url));
                            }

                            // combine remaining old urls + new uploaded urls
                            const combinedUrls = [...remainingUrls, ...insertPayload.gallery_urls];
                            insertPayload.gallery_urls = combinedUrls.length > 0 ? combinedUrls : null;
                        }
                    }

                    const { error } = await supabaseClient
                        .from('news')
                        .update(insertPayload)
                        .eq('id', editId);

                    if (error) throw error;
                    alertBox.textContent = 'อัปเดตข่าวสารเรียบร้อยแล้ว!';
                } else {
                    btn.textContent = 'กำลังบันทึกข้อมูลใหม่...';
                    const { error } = await supabaseClient
                        .from('news')
                        .insert([insertPayload]);

                    if (error) throw error;
                    alertBox.textContent = 'บันทึกข่าวใหม่เรียบร้อยแล้ว!';
                }

                alertBox.className = 'alert alert-success';
                alertBox.style.display = 'block';

                // Reset form & UI state
                resetAdminForm();

                // Refresh table
                loadAdminNews();

            } catch (error) {
                console.error('Error handling news:', error);
                alertBox.className = 'alert alert-error';
                alertBox.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
                alertBox.style.display = 'block';

                // Restore button state
                btn.textContent = editId ? 'อัปเดตข้อมูลข่าวสาร' : 'บันทึกและเผยแพร่ข่าว';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>